<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego</title>
</head>

<body>
    <h1 style="text-align: center;">Atrapando villanos de batman</h1>

    <canvas id="canvas" width="1920" height="1080" style="border: 3px solid black;"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // datos de django
        const paredes = {{ paredes|safe }};
        const personaje = {
            x: {{ personaje.x }},
            y: {{ personaje.y }},
            imagen: "{{ personaje.imagen }}",
        };
        const villanos = {
            x: {{villanos.x}},
            y: {{villanos.y}},
            imagen: "{{villanos.imagen}}"
        };

        const img = new Image();
        img.src = personaje.imagen;

        img.onload = function () {
            dibujarTodo();
        };

        // detectar colicion 
        function colisionaConParedes(nx, ny) {
            const personajeWidth = 50;
            const personajeHeight = 50;

            for (let p of paredes) {

                // horizontal (y1 == y2)
                if (p.direccion === "H") {
                    let x_min = Math.min(p.x1, p.x2);
                    let x_max = Math.max(p.x1, p.x2);

                    let colision_x = nx + personajeWidth > x_min && nx < x_max;
                    let colision_y = ny < p.y1 + 5 && ny + personajeHeight > p.y1;

                    if (colision_x && colision_y) {
                        return true;
                    }
                }

                // vertical (x1 == x2)
                if (p.direccion === "V") {
                    let y_min = Math.min(p.y1, p.y2);
                    let y_max = Math.max(p.y1, p.y2);

                    let colision_y = ny + personajeHeight > y_min && ny < y_max;
                    let colision_x = nx < p.x1 + 5 && nx + personajeWidth > p.x1;

                    if (colision_x && colision_y) {
                        return true;
                    }
                }
            }
            return false;
        }

        function dibujarTodo() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            paredes.forEach(p => {
                ctx.beginPath();
                ctx.moveTo(p.x1, p.y1);
                ctx.lineTo(p.x2, p.y2);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 5;
                ctx.stroke();
            });

            ctx.drawImage(img, personaje.x, personaje.y, 50, 50);
        }

        document.addEventListener("keydown", function (event) {

            let nx = personaje.x;
            let ny = personaje.y;

            if (event.key === "w") ny -= 10;
            if (event.key === "s") ny += 10;
            if (event.key === "a") nx -= 10;
            if (event.key === "d") nx += 10;

            if (!colisionaConParedes(nx, ny)) {
                personaje.x = nx;
                personaje.y = ny;
            }

            if (personaje.x < 0) personaje.x = 0;
            if (personaje.y < 0) personaje.y = 0;
            if (personaje.x > canvas.width - 50) personaje.x = canvas.width - 50;
            if (personaje.y > canvas.height - 50) personaje.y = canvas.height - 50;

            dibujarTodo();
        });

    </script>

</body>

</html>
