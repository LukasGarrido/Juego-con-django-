<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego</title>
</head>

<body>
    <h1 style="text-align: center;">Atrapando villanos de batman</h1>

    <canvas id="canvas" width="1920" height="1080" style="border: 3px solid black;"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // === DATOS DESDE DJANGO ===
        const paredes = {{ paredes|safe }};
        const personaje = {
            x: {{ personaje.x }},
            y: {{ personaje.y }},
            imagen: "{{ personaje.imagen }}"
        };

        // ðŸ”¥ LOS VILLANOS LLEGAN COMO OBJETOS DJANGO SERIALIZADOS POR TEMPLATE
        const villanos = [
            {% for v in villanos %}
                {
                    nombre: "{{ v.nombre }}",
                    imagen: "{{ v.imagen }}",
                    x: {{ v.x }},
                    y: {{ v.y }}
                },
            {% endfor %}
        ];

        // === IMAGEN DEL PERSONAJE ===
        const imgPersonaje = new Image();
        imgPersonaje.src = personaje.imagen;

        // === CARGAR IMÃGENES DE VILLANOS ===
        const imgVillanos = [];

        villanos.forEach(v => {
            let iv = new Image();
            iv.src = v.imagen;
            imgVillanos.push({
                img: iv,
                x: v.x,
                y: v.y
            });
        });

        imgPersonaje.onload = function () {
            dibujarTodo();
        };

        // === DETECTAR COLISIONES ===
        function colisionaConParedes(nx, ny) {
            const w = 50;
            const h = 50;

            for (let p of paredes) {

                if (p.direccion === "H") {
                    let xmin = Math.min(p.x1, p.x2);
                    let xmax = Math.max(p.x1, p.x2);

                    let colX = nx + w > xmin && nx < xmax;
                    let colY = ny < p.y1 + 5 && ny + h > p.y1;

                    if (colX && colY) return true;
                }

                if (p.direccion === "V") {
                    let ymin = Math.min(p.y1, p.y2);
                    let ymax = Math.max(p.y1, p.y2);

                    let colY = ny + h > ymin && ny < ymax;
                    let colX = nx < p.x1 + 5 && nx + w > p.x1;

                    if (colX && colY) return true;
                }
            }
            return false;
        }

        // === DIBUJAR TODO ===
        function dibujarTodo() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // paredes
            paredes.forEach(p => {
                ctx.beginPath();
                ctx.moveTo(p.x1, p.y1);
                ctx.lineTo(p.x2, p.y2);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 5;
                ctx.stroke();
            });

            // ðŸ”¥ VILLANOS (SE QUEDAN QUIETOS)
            imgVillanos.forEach(v => {
                ctx.drawImage(v.img, v.x, v.y, 50, 50);
            });

            // personaje
            ctx.drawImage(imgPersonaje, personaje.x, personaje.y, 50, 50);
        }

        // === MOVIMIENTO ===
        document.addEventListener("keydown", function (event) {

            let nx = personaje.x;
            let ny = personaje.y;

            if (event.key === "w") ny -= 10;
            if (event.key === "s") ny += 10;
            if (event.key === "a") nx -= 10;
            if (event.key === "d") nx += 10;

            if (!colisionaConParedes(nx, ny)) {
                personaje.x = nx;
                personaje.y = ny;
            }

            if (personaje.x < 0) personaje.x = 0;
            if (personaje.y < 0) personaje.y = 0;
            if (personaje.x > canvas.width - 50) personaje.x = canvas.width - 50;
            if (personaje.y > canvas.height - 50) personaje.y = canvas.height - 50;

            dibujarTodo();
        });

    </script>

</body>

</html>
