<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta viewport="width=device-width, initial-scale=1.0">
    <title>Juego</title>
</head>

<body>
    <h1 style="text-align: center;">Atrapando villanos de batman</h1>

    <canvas id="canvas" width="1920" height="1080" style="border: 3px solid black;"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const paredes = {{ paredes|safe }};
        const personaje = {
            x: {{ personaje.x }},
            y: {{ personaje.y }},
            imagen: "{{ personaje.imagen }}"
        };

        const villanos = [
            {% for v in villanos %}
            {
                nombre: "{{ v.nombre }}",
                imagen: "{{ v.imagen }}",
                x: {{ v.x }},
                y: {{ v.y }}
            },
            {% endfor %}
        ];

        const imgPersonaje = new Image();
        imgPersonaje.src = personaje.imagen;

        const imgVillanos = [];
        villanos.forEach(v => {
            let iv = new Image();
            iv.src = v.imagen;
            imgVillanos.push({ img: iv, x: v.x, y: v.y });
        });

        const fondo = new Image();
        fondo.src = "/static/img/gotica.png";

        imgPersonaje.onload = () => dibujarTodo();

        function colisionaConParedes(nx, ny) {
            const w = 50, h = 50;

            for (let p of paredes) {
                if (p.direccion === "H") {
                    let xmin = Math.min(p.x1, p.x2);
                    let xmax = Math.max(p.x1, p.x2);

                    if (nx + w > xmin && nx < xmax &&
                        ny < p.y1 + 5 && ny + h > p.y1)
                        return true;
                }
                if (p.direccion === "V") {
                    let ymin = Math.min(p.y1, p.y2);
                    let ymax = Math.max(p.y1, p.y2);

                    if (ny + h > ymin && ny < ymax &&
                        nx < p.x1 + 5 && nx + w > p.x1)
                        return true;
                }
            }
            return false;
        }

        function dibujarMensajeFin() {
            ctx.fillStyle = "rgba(0,0,0,0.7)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "white";
            ctx.font = "80px Arial";
            ctx.textAlign = "center";
            ctx.fillText("ðŸŽ‰ Â¡FIN DEL JUEGO! ðŸŽ‰", canvas.width / 2, canvas.height / 2);
        }

        function dibujarTodo() {
            ctx.drawImage(fondo, 0, 0, canvas.width, canvas.height);

            paredes.forEach(p => {
                ctx.beginPath();
                ctx.moveTo(p.x1, p.y1);
                ctx.lineTo(p.x2, p.y2);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 5;
                ctx.stroke();
            });

            imgVillanos.forEach(v => {
                ctx.drawImage(v.img, v.x, v.y, 50, 50);
            });

            ctx.drawImage(imgPersonaje, personaje.x, personaje.y, 50, 50);

            if (imgVillanos.length === 0) {
                dibujarMensajeFin();
            }
        }

        function colisionaConVillano(v) {
            return (
                personaje.x < v.x + 50 &&
                personaje.x + 50 > v.x &&
                personaje.y < v.y + 50 &&
                personaje.y + 50 > v.y
            );
        }

        document.addEventListener("keydown", function (event) {

            let nx = personaje.x, ny = personaje.y;

            if (event.key === "w") ny -= 10;
            if (event.key === "s") ny += 10;
            if (event.key === "a") nx -= 10;
            if (event.key === "d") nx += 10;

            if (!colisionaConParedes(nx, ny)) {
                personaje.x = nx;
                personaje.y = ny;
            }

            if (personaje.x < 0) personaje.x = 0;
            if (personaje.y < 0) personaje.y = 0;
            if (personaje.x > canvas.width - 50) personaje.x = canvas.width - 50;
            if (personaje.y > canvas.height - 50) personaje.y = canvas.height - 50;

            for (let i = imgVillanos.length - 1; i >= 0; i--) {
                if (colisionaConVillano(imgVillanos[i])) {
                    imgVillanos.splice(i, 1);
                }
            }

            dibujarTodo();
        });

    </script>

</body>
</html>
